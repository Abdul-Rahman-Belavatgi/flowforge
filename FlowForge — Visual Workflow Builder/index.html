<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FlowForge ‚Äî Visual Workflow Builder</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0d0d14;--bg2:#13131e;--bg3:#1a1a28;
  --border:#ffffff10;--border2:#ffffff1e;
  --text:#f2f2ff;--text2:#8888bb;--text3:#44445e;
  --purple:#8b5cf6;--blue:#3b82f6;--green:#22c55e;
  --orange:#f97316;--red:#ef4444;--yellow:#eab308;
  --font:'Outfit',sans-serif;--mono:'JetBrains Mono',monospace;
}
body{background:var(--bg);color:var(--text);font-family:var(--font);height:100vh;overflow:hidden;user-select:none}
/* Layout */
.app{display:grid;grid-template-rows:52px 1fr;height:100vh}
.toolbar{background:var(--bg2);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 20px;gap:16px}
.brand{font-size:17px;font-weight:800;letter-spacing:-0.5px;color:var(--text)}
.brand span{color:var(--purple)}
.toolbar-center{display:flex;align-items:center;gap:8px}
.tool-btn{background:transparent;border:1px solid var(--border);color:var(--text2);font-family:var(--font);font-size:12px;font-weight:600;padding:6px 14px;border-radius:6px;cursor:pointer;transition:all 0.15s}
.tool-btn:hover{border-color:var(--border2);color:var(--text)}
.tool-btn.active{border-color:var(--purple);color:var(--purple);background:#8b5cf610}
.sep{width:1px;height:24px;background:var(--border);margin:0 4px}
.toolbar-right{display:flex;align-items:center;gap:8px}
.run-btn{background:var(--purple);color:#fff;font-family:var(--font);font-weight:700;font-size:13px;border:none;padding:8px 20px;border-radius:8px;cursor:pointer;transition:all 0.15s;display:flex;align-items:center;gap:6px}
.run-btn:hover{background:#7c3aed;transform:translateY(-1px)}
.run-btn.running{background:var(--orange);animation:runPulse 1s infinite}
@keyframes runPulse{0%,100%{opacity:1}50%{opacity:0.7}}
/* Main Area */
.workspace{display:grid;grid-template-columns:240px 1fr 280px;height:calc(100vh - 52px)}
/* Node Palette */
.palette{background:var(--bg2);border-right:1px solid var(--border);padding:16px;overflow-y:auto;display:flex;flex-direction:column;gap:16px}
.palette-section{}
.palette-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--text3);margin-bottom:10px;padding-left:2px}
.node-list{display:flex;flex-direction:column;gap:4px}
.palette-node{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg3);cursor:grab;transition:all 0.15s;font-size:13px;font-weight:500}
.palette-node:hover{border-color:var(--border2);transform:translateX(2px)}
.palette-node:active{cursor:grabbing}
.node-icon{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
/* Canvas */
.canvas-wrap{position:relative;overflow:hidden;background:var(--bg);background-image:radial-gradient(circle,var(--border) 1px,transparent 1px);background-size:28px 28px}
.canvas{position:absolute;width:100%;height:100%}
/* Flow Nodes */
.flow-node{position:absolute;background:var(--bg2);border:2px solid var(--border);border-radius:12px;min-width:180px;cursor:move;transition:border-color 0.15s,box-shadow 0.15s;z-index:10}
.flow-node:hover{border-color:var(--border2);box-shadow:0 4px 24px #00000040}
.flow-node.selected{border-color:var(--purple);box-shadow:0 0 0 3px #8b5cf620}
.flow-node.running-node{border-color:var(--green);box-shadow:0 0 0 3px #22c55e20;animation:nodeRun 1s infinite}
@keyframes nodeRun{0%,100%{box-shadow:0 0 0 3px #22c55e20}50%{box-shadow:0 0 0 6px #22c55e40}}
.node-header{padding:10px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px}
.node-header-icon{width:24px;height:24px;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0}
.node-label{font-size:13px;font-weight:600;flex:1}
.node-del{background:none;border:none;color:var(--text3);cursor:pointer;font-size:14px;opacity:0;transition:opacity 0.15s;line-height:1}
.flow-node:hover .node-del{opacity:1}
.node-del:hover{color:var(--red)}
.node-body{padding:10px 14px}
.node-field{margin-bottom:8px}
.node-field:last-child{margin-bottom:0}
.node-field-label{font-size:10px;color:var(--text3);font-family:var(--mono);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px}
.node-field-val{font-size:12px;color:var(--text2);font-family:var(--mono)}
.node-ports{position:relative}
.port-in,.port-out{width:12px;height:12px;border-radius:50%;background:var(--bg3);border:2px solid var(--border2);position:absolute;top:50%;transform:translateY(-50%);cursor:crosshair;transition:all 0.15s}
.port-in{left:-7px}
.port-out{right:-7px}
.port-in:hover,.port-out:hover{border-color:var(--purple);background:var(--purple);transform:translateY(-50%) scale(1.3)}
/* SVG connections */
.connections{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:5}
.conn-path{fill:none;stroke:var(--border2);stroke-width:2;stroke-dasharray:5,5;animation:dash 1s linear infinite}
@keyframes dash{to{stroke-dashoffset:-10}}
.conn-path.active{stroke:var(--purple);stroke-dasharray:none;animation:none}
.conn-path.running-conn{stroke:var(--green);stroke-dasharray:none;stroke-width:2.5;animation:connFlow 0.8s linear infinite}
@keyframes connFlow{from{stroke-dashoffset:0}to{stroke-dashoffset:-20}}
/* Properties Panel */
.props-panel{background:var(--bg2);border-left:1px solid var(--border);padding:20px;overflow-y:auto;display:flex;flex-direction:column;gap:16px}
.props-title{font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px}
.props-sub{font-size:11px;color:var(--text3);font-family:var(--mono);margin-bottom:12px}
.props-field{display:flex;flex-direction:column;gap:6px;margin-bottom:14px}
.props-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text3);font-family:var(--mono)}
.props-input{background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:var(--font);font-size:12px;padding:8px 12px;border-radius:6px;outline:none;transition:border-color 0.15s}
.props-input:focus{border-color:var(--purple)}
.props-select{background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:var(--font);font-size:12px;padding:8px 12px;border-radius:6px;outline:none;appearance:none}
.props-textarea{background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:var(--mono);font-size:11px;padding:8px 12px;border-radius:6px;outline:none;resize:vertical;min-height:80px;line-height:1.6}
.props-textarea:focus{border-color:var(--purple)}
.props-divider{height:1px;background:var(--border);margin:4px 0}
.exec-log{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px;font-family:var(--mono);font-size:11px;line-height:1.8;color:var(--text2);max-height:180px;overflow-y:auto}
.exec-log .ok{color:var(--green)}
.exec-log .warn{color:var(--yellow)}
.exec-log .err{color:var(--red)}
.exec-log .info{color:var(--blue)}
/* Empty state */
.empty-canvas{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;pointer-events:none}
.empty-icon{font-size:48px;margin-bottom:12px;opacity:0.15}
.empty-text{font-size:15px;font-weight:600;color:var(--text2);opacity:0.4}
.empty-sub{font-size:12px;color:var(--text3);margin-top:6px;opacity:0.4}
/* Toast */
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--bg2);border:1px solid var(--purple);color:var(--purple);padding:10px 20px;border-radius:8px;font-size:13px;font-weight:600;z-index:999;animation:toastIn 0.3s ease;white-space:nowrap}
@keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(8px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
/* Scrollbar */
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
</style>
</head>
<body>
<div class="app">
  <div class="toolbar">
    <div class="brand">Flow<span>Forge</span></div>
    <div class="toolbar-center">
      <button class="tool-btn active" id="toolSelect">‚Üñ Select</button>
      <button class="tool-btn" id="toolConnect">‚ü∂ Connect</button>
      <div class="sep"></div>
      <button class="tool-btn" id="undoBtn">‚Ü© Undo</button>
      <button class="tool-btn" id="clearBtn">‚å´ Clear</button>
      <button class="tool-btn" id="saveBtn">üíæ Save</button>
      <button class="tool-btn" id="loadBtn">üìÇ Load Demo</button>
    </div>
    <div class="toolbar-right">
      <span style="font-size:12px;color:var(--text3);font-family:var(--mono)" id="nodeCount">0 nodes</span>
      <button class="run-btn" id="runBtn">‚ñ∂ Run Workflow</button>
    </div>
  </div>
  <div class="workspace">
    <!-- Palette -->
    <div class="palette">
      <div class="palette-section">
        <div class="palette-title">Triggers</div>
        <div class="node-list">
          <div class="palette-node" draggable="true" data-type="webhook" data-color="var(--purple)" data-icon="üîó">
            <div class="node-icon" style="background:#8b5cf620">üîó</div> Webhook
          </div>
          <div class="palette-node" draggable="true" data-type="schedule" data-color="var(--blue)" data-icon="‚è±">
            <div class="node-icon" style="background:#3b82f620">‚è±</div> Schedule
          </div>
          <div class="palette-node" draggable="true" data-type="email_trigger" data-color="var(--orange)" data-icon="üìß">
            <div class="node-icon" style="background:#f9731620">üìß</div> Email Received
          </div>
          <div class="palette-node" draggable="true" data-type="form" data-color="var(--green)" data-icon="üìã">
            <div class="node-icon" style="background:#22c55e20">üìã</div> Form Submit
          </div>
        </div>
      </div>
      <div class="palette-section">
        <div class="palette-title">Actions</div>
        <div class="node-list">
          <div class="palette-node" draggable="true" data-type="send_email" data-color="var(--orange)" data-icon="üì§">
            <div class="node-icon" style="background:#f9731620">üì§</div> Send Email
          </div>
          <div class="palette-node" draggable="true" data-type="http" data-color="var(--blue)" data-icon="üåê">
            <div class="node-icon" style="background:#3b82f620">üåê</div> HTTP Request
          </div>
          <div class="palette-node" draggable="true" data-type="database" data-color="var(--green)" data-icon="üóÑ">
            <div class="node-icon" style="background:#22c55e20">üóÑ</div> Database Query
          </div>
          <div class="palette-node" draggable="true" data-type="slack" data-color="var(--purple)" data-icon="üí¨">
            <div class="node-icon" style="background:#8b5cf620">üí¨</div> Slack Message
          </div>
          <div class="palette-node" draggable="true" data-type="gsheets" data-color="var(--green)" data-icon="üìä">
            <div class="node-icon" style="background:#22c55e20">üìä</div> Google Sheets
          </div>
          <div class="palette-node" draggable="true" data-type="openai" data-color="var(--yellow)" data-icon="‚ú®">
            <div class="node-icon" style="background:#eab30820">‚ú®</div> OpenAI / LLM
          </div>
        </div>
      </div>
      <div class="palette-section">
        <div class="palette-title">Logic</div>
        <div class="node-list">
          <div class="palette-node" draggable="true" data-type="condition" data-color="var(--yellow)" data-icon="‚óà">
            <div class="node-icon" style="background:#eab30820">‚óà</div> Condition / IF
          </div>
          <div class="palette-node" draggable="true" data-type="delay" data-color="var(--text2)" data-icon="‚è≥">
            <div class="node-icon" style="background:#88888820">‚è≥</div> Delay / Wait
          </div>
          <div class="palette-node" draggable="true" data-type="loop" data-color="var(--blue)" data-icon="üîÑ">
            <div class="node-icon" style="background:#3b82f620">üîÑ</div> Loop / Each
          </div>
          <div class="palette-node" draggable="true" data-type="transform" data-color="var(--purple)" data-icon="‚ö°">
            <div class="node-icon" style="background:#8b5cf620">‚ö°</div> Transform Data
          </div>
        </div>
      </div>
    </div>
    <!-- Canvas -->
    <div class="canvas-wrap" id="canvasWrap">
      <svg class="connections" id="svgLayer"></svg>
      <div class="canvas" id="canvas">
        <div class="empty-canvas" id="emptyState">
          <div class="empty-icon">‚ö°</div>
          <div class="empty-text">Drag nodes to build your workflow</div>
          <div class="empty-sub">or click "Load Demo" to see an example</div>
        </div>
      </div>
    </div>
    <!-- Properties -->
    <div class="props-panel" id="propsPanel">
      <div>
        <div class="props-title">Properties</div>
        <div class="props-sub">Select a node to configure</div>
      </div>
      <div id="propsContent">
        <div style="font-size:12px;color:var(--text3);font-family:var(--mono);line-height:1.8">
          ‚Üê Click any node on the canvas to see and edit its configuration.<br><br>
          Drag nodes from the palette on the left to add them to your workflow.<br><br>
          Connect nodes by clicking "Connect" mode then dragging from one node to another.
        </div>
      </div>
      <div class="props-divider"></div>
      <div>
        <div class="props-label" style="margin-bottom:8px">Execution Log</div>
        <div class="exec-log" id="execLog">
          <span class="info">// Workflow not yet run</span>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
'use strict';
let nodes=[], connections=[], selectedNode=null, connectMode=false;
let dragNode=null, dragOffset={x:0,y:0};
let connectFrom=null, nodeIdCounter=0, history=[];

const nodeConfigs={
  webhook:{label:'Webhook',icon:'üîó',color:'#8b5cf6',fields:{Method:'POST',Path:'/webhook/trigger',Auth:'Bearer Token'}},
  schedule:{label:'Schedule',icon:'‚è±',color:'#3b82f6',fields:{Cron:'0 9 * * MON-FRI',Timezone:'UTC',Enabled:'true'}},
  email_trigger:{label:'Email Received',icon:'üìß',color:'#f97316',fields:{From:'*@company.com',Subject:'contains "urgent"',Mailbox:'support@'}},
  form:{label:'Form Submit',icon:'üìã',color:'#22c55e',fields:{FormID:'contact-form-v2',Fields:'name, email, message',Redirect:'/thank-you'}},
  send_email:{label:'Send Email',icon:'üì§',color:'#f97316',fields:{To:'{{data.email}}',Subject:'Your request received',From:'noreply@'}},
  http:{label:'HTTP Request',icon:'üåê',color:'#3b82f6',fields:{URL:'https://api.example.com/data',Method:'GET',Headers:'Authorization: Bearer {{token}}'}},
  database:{label:'Database Query',icon:'üóÑ',color:'#22c55e',fields:{Connection:'PostgreSQL',Query:'SELECT * FROM leads WHERE...',Mode:'read'}},
  slack:{label:'Slack Message',icon:'üí¨',color:'#8b5cf6',fields:{Channel:'#alerts',Message:'New submission: {{data.name}}',Bot:'AutoBot'}},
  gsheets:{label:'Google Sheets',icon:'üìä',color:'#22c55e',fields:{SpreadsheetID:'1BxiMVs0...',Sheet:'Sheet1',Action:'Append Row'}},
  openai:{label:'OpenAI / LLM',icon:'‚ú®',color:'#eab308',fields:{Model:'gpt-4',Prompt:'Classify this email: {{data.body}}',MaxTokens:'500'}},
  condition:{label:'Condition / IF',icon:'‚óà',color:'#eab308',fields:{Condition:'{{data.score}} > 80',TrueLabel:'Qualified',FalseLabel:'Not Qualified'}},
  delay:{label:'Delay / Wait',icon:'‚è≥',color:'#8888bb',fields:{Duration:'2',Unit:'hours',Description:'Wait before follow-up'}},
  loop:{label:'Loop / Each',icon:'üîÑ',color:'#3b82f6',fields:{Over:'{{data.items}}',Variable:'item',BatchSize:'10'}},
  transform:{label:'Transform Data',icon:'‚ö°',color:'#8b5cf6',fields:{Input:'{{data}}',Script:'return data.map(i => ({...i, score: i.value * 10}))',Output:'transformedData'}},
};

function getCanvas(){return document.getElementById('canvas');}
function getSVG(){return document.getElementById('svgLayer');}

function saveHistory(){
  history.push(JSON.stringify({nodes:nodes.map(n=>({...n})),connections:[...connections]}));
  if(history.length>50)history.shift();
}

function createNodeEl(node){
  const cfg=nodeConfigs[node.type];
  const el=document.createElement('div');
  el.className='flow-node';
  el.id='node-'+node.id;
  el.style.left=node.x+'px';
  el.style.top=node.y+'px';
  el.innerHTML=`
    <div class="node-header">
      <div class="node-header-icon" style="background:${cfg.color}20">${cfg.icon}</div>
      <span class="node-label">${cfg.label}</span>
      <button class="node-del" data-id="${node.id}" title="Delete">‚úï</button>
    </div>
    <div class="node-body">
      ${Object.entries(cfg.fields).map(([k,v])=>`
        <div class="node-field">
          <div class="node-field-label">${k}</div>
          <div class="node-field-val" title="${v}">${v.length>22?v.slice(0,22)+'‚Ä¶':v}</div>
        </div>`).join('')}
    </div>
    <div class="node-ports">
      ${node.type!=='webhook'&&node.type!=='schedule'&&node.type!=='email_trigger'&&node.type!=='form'?
        `<div class="port-in" data-id="${node.id}" title="Input"></div>`:''}
      <div class="port-out" data-id="${node.id}" title="Output"></div>
    </div>`;
  el.querySelector('.node-del').addEventListener('click',e=>{
    e.stopPropagation();
    deleteNode(node.id);
  });
  el.addEventListener('mousedown',e=>{
    if(e.target.classList.contains('port-out')||e.target.classList.contains('port-in'))return;
    if(connectMode)return;
    e.stopPropagation();
    dragNode=node;
    const rect=el.getBoundingClientRect();
    const wrap=document.getElementById('canvasWrap').getBoundingClientRect();
    dragOffset={x:e.clientX-rect.left,y:e.clientY-rect.top};
    selectNode(node.id);
  });
  el.querySelector('.port-out').addEventListener('click',e=>{
    e.stopPropagation();
    if(!connectMode){showToast('Switch to Connect mode first');return;}
    if(!connectFrom){connectFrom=node.id;el.querySelector('.port-out').style.borderColor='var(--purple)';showToast('Now click the input port of a target node');}
  });
  const portIn=el.querySelector('.port-in');
  if(portIn){
    portIn.addEventListener('click',e=>{
      e.stopPropagation();
      if(!connectMode){showToast('Switch to Connect mode first');return;}
      if(connectFrom&&connectFrom!==node.id){
        const exists=connections.find(c=>c.from===connectFrom&&c.to===node.id);
        if(!exists){
          saveHistory();
          connections.push({from:connectFrom,to:node.id,id:'conn-'+Date.now()});
          drawConnections();
        }
        const fromEl=document.getElementById('node-'+connectFrom);
        if(fromEl)fromEl.querySelector('.port-out').style.borderColor='';
        connectFrom=null;
        showToast('‚úì Nodes connected');
      }
    });
  }
  el.addEventListener('click',e=>{
    if(e.target.classList.contains('port-out')||e.target.classList.contains('port-in'))return;
    selectNode(node.id);
  });
  getCanvas().appendChild(el);
  updateNodeCount();
}

function selectNode(id){
  document.querySelectorAll('.flow-node').forEach(n=>n.classList.remove('selected'));
  const el=document.getElementById('node-'+id);
  if(el)el.classList.add('selected');
  selectedNode=nodes.find(n=>n.id===id);
  renderProps();
}

function deleteNode(id){
  saveHistory();
  nodes=nodes.filter(n=>n.id!==id);
  connections=connections.filter(c=>c.from!==id&&c.to!==id);
  const el=document.getElementById('node-'+id);
  if(el)el.remove();
  selectedNode=null;
  renderProps();
  drawConnections();
  updateNodeCount();
  document.getElementById('emptyState').style.display=nodes.length===0?'block':'none';
}

function addNode(type, x, y){
  saveHistory();
  const node={id:++nodeIdCounter,type,x,y};
  nodes.push(node);
  createNodeEl(node);
  document.getElementById('emptyState').style.display='none';
  selectNode(node.id);
}

function drawConnections(){
  const svg=getSVG();
  svg.innerHTML='';
  connections.forEach(c=>{
    const fromEl=document.getElementById('node-'+c.from);
    const toEl=document.getElementById('node-'+c.to);
    if(!fromEl||!toEl)return;
    const fromRect=fromEl.getBoundingClientRect();
    const toRect=toEl.getBoundingClientRect();
    const wrap=document.getElementById('canvasWrap').getBoundingClientRect();
    const x1=fromRect.right-wrap.left;
    const y1=fromRect.top+fromRect.height/2-wrap.top;
    const x2=toRect.left-wrap.left;
    const y2=toRect.top+toRect.height/2-wrap.top;
    const cp=Math.abs(x2-x1)*0.5;
    const path=document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d',`M${x1},${y1} C${x1+cp},${y1} ${x2-cp},${y2} ${x2},${y2}`);
    path.setAttribute('class','conn-path');
    path.setAttribute('id',c.id);
    svg.appendChild(path);
  });
}

function renderProps(){
  const content=document.getElementById('propsContent');
  if(!selectedNode){
    content.innerHTML=`<div style="font-size:12px;color:var(--text3);font-family:var(--mono);line-height:1.8">Click a node to configure it.</div>`;
    return;
  }
  const cfg=nodeConfigs[selectedNode.type];
  content.innerHTML=`
    <div class="props-title">${cfg.icon} ${cfg.label}</div>
    <div class="props-sub">Node ID: #${selectedNode.id} ¬∑ Type: ${selectedNode.type}</div>
    ${Object.entries(cfg.fields).map(([k,v])=>`
      <div class="props-field">
        <div class="props-label">${k}</div>
        <input class="props-input" value="${v}" data-field="${k}" placeholder="${k}...">
      </div>`).join('')}
    <div class="props-divider"></div>
    <div class="props-field">
      <div class="props-label">Notes</div>
      <textarea class="props-textarea" placeholder="Add notes for this node..."></textarea>
    </div>`;
}

function updateNodeCount(){
  document.getElementById('nodeCount').textContent=nodes.length+' node'+(nodes.length!==1?'s':'');
}

function logExec(msg, type='info'){
  const log=document.getElementById('execLog');
  const line=document.createElement('div');
  line.className=type;
  line.textContent=msg;
  log.appendChild(line);
  log.scrollTop=log.scrollHeight;
}

async function runWorkflow(){
  if(nodes.length===0){showToast('‚ö† Add nodes to the canvas first');return;}
  const btn=document.getElementById('runBtn');
  btn.textContent='‚ü≥ Running‚Ä¶';
  btn.classList.add('running');
  const log=document.getElementById('execLog');
  log.innerHTML='';
  const sortedNodes=[...nodes];
  for(let i=0;i<sortedNodes.length;i++){
    const n=sortedNodes[i];
    const el=document.getElementById('node-'+n.id);
    const cfg=nodeConfigs[n.type];
    if(el)el.classList.add('running-node');
    connections.filter(c=>c.from===n.id).forEach(c=>{
      const path=document.getElementById(c.id);
      if(path)path.classList.add('running-conn');
    });
    logExec(`‚ñ∂ Executing: ${cfg.label} (#${n.id})`,'info');
    await new Promise(r=>setTimeout(r,700));
    logExec(`‚úì ${cfg.label} completed successfully`,'ok');
    if(el)el.classList.remove('running-node');
  }
  logExec('‚úì Workflow finished ‚Äî '+sortedNodes.length+' nodes executed','ok');
  document.querySelectorAll('.running-conn').forEach(p=>p.classList.remove('running-conn'));
  btn.textContent='‚ñ∂ Run Workflow';
  btn.classList.remove('running');
  showToast('‚úì Workflow completed successfully');
}

function loadDemo(){
  getCanvas().querySelectorAll('.flow-node').forEach(n=>n.remove());
  nodes=[];connections=[];nodeIdCounter=0;selectedNode=null;
  document.getElementById('emptyState').style.display='none';
  const demo=[
    {type:'webhook',x:60,y:200},{type:'condition',x:280,y:200},
    {type:'openai',x:500,y:100},{type:'slack',x:720,y:100},
    {type:'send_email',x:500,y:300},{type:'database',x:720,y:300},
  ];
  demo.forEach(d=>addNode(d.type,d.x,d.y));
  connections=[
    {from:1,to:2,id:'conn-d1'},{from:2,to:3,id:'conn-d2'},
    {from:2,to:5,id:'conn-d3'},{from:3,to:4,id:'conn-d4'},
    {from:5,to:6,id:'conn-d5'},
  ];
  drawConnections();
  showToast('‚úì Demo workflow loaded');
}

function showToast(msg){
  const t=document.querySelector('.toast');if(t)t.remove();
  const el=document.createElement('div');el.className='toast';el.textContent=msg;
  document.body.appendChild(el);setTimeout(()=>el.remove(),2800);
}

// Drag from palette
document.querySelectorAll('.palette-node').forEach(el=>{
  el.addEventListener('dragstart',e=>{
    e.dataTransfer.setData('type',el.dataset.type);
  });
});
const canvasWrap=document.getElementById('canvasWrap');
canvasWrap.addEventListener('dragover',e=>e.preventDefault());
canvasWrap.addEventListener('drop',e=>{
  e.preventDefault();
  const type=e.dataTransfer.getData('type');
  if(!type)return;
  const rect=canvasWrap.getBoundingClientRect();
  addNode(type,e.clientX-rect.left-90,e.clientY-rect.top-60);
  drawConnections();
});

// Canvas drag (move nodes)
document.addEventListener('mousemove',e=>{
  if(!dragNode)return;
  const wrap=document.getElementById('canvasWrap').getBoundingClientRect();
  const x=Math.max(0,e.clientX-wrap.left-dragOffset.x);
  const y=Math.max(0,e.clientY-wrap.top-dragOffset.y);
  dragNode.x=x;dragNode.y=y;
  const el=document.getElementById('node-'+dragNode.id);
  if(el){el.style.left=x+'px';el.style.top=y+'px';}
  drawConnections();
});
document.addEventListener('mouseup',()=>{dragNode=null;});
canvasWrap.addEventListener('click',e=>{
  if(e.target===canvasWrap||e.target.id==='canvas'||e.target.id==='svgLayer'){
    document.querySelectorAll('.flow-node').forEach(n=>n.classList.remove('selected'));
    selectedNode=null;renderProps();
    if(connectFrom){
      const fromEl=document.getElementById('node-'+connectFrom);
      if(fromEl)fromEl.querySelector('.port-out').style.borderColor='';
      connectFrom=null;
    }
  }
});

// Toolbar
document.getElementById('toolSelect').addEventListener('click',()=>{
  connectMode=false;
  document.getElementById('toolSelect').classList.add('active');
  document.getElementById('toolConnect').classList.remove('active');
  connectFrom=null;
});
document.getElementById('toolConnect').addEventListener('click',()=>{
  connectMode=true;
  document.getElementById('toolConnect').classList.add('active');
  document.getElementById('toolSelect').classList.remove('active');
  showToast('Connect mode: click output port then input port');
});
document.getElementById('undoBtn').addEventListener('click',()=>{
  if(!history.length){showToast('Nothing to undo');return;}
  const prev=JSON.parse(history.pop());
  getCanvas().querySelectorAll('.flow-node').forEach(n=>n.remove());
  nodes=prev.nodes;connections=prev.connections;nodeIdCounter=nodes.length;
  nodes.forEach(n=>createNodeEl(n));
  drawConnections();updateNodeCount();
  showToast('‚Ü© Undone');
});
document.getElementById('clearBtn').addEventListener('click',()=>{
  saveHistory();
  getCanvas().querySelectorAll('.flow-node').forEach(n=>n.remove());
  nodes=[];connections=[];selectedNode=null;
  renderProps();drawConnections();updateNodeCount();
  document.getElementById('emptyState').style.display='block';
  showToast('Canvas cleared');
});
document.getElementById('saveBtn').addEventListener('click',()=>{
  const data=JSON.stringify({nodes,connections},null,2);
  const blob=new Blob([data],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download='workflow.json';a.click();
  showToast('‚úì Workflow saved');
});
document.getElementById('loadBtn').addEventListener('click',loadDemo);
document.getElementById('runBtn').addEventListener('click',runWorkflow);
</script>
</body>
</html>
